import unittest
import random
from common.storage_location import StorageLocation
from ml.pipeline.faiss import FaissPipeline
from ml.pipeline.embed import EmbedPipeline
from ml.pipeline.imageToText import ImageToTextPipeline
import json


class TestFaiss(unittest.TestCase):
    JSON_TEXT_ITEMS = """[
    {
      "_id": 1,
      "database": "unit_test",
      "index_id": "test_index_id",
      "primary_key_name": "_id",
      "primary_key_value": "1",
      "column_name": "title",
      "column_value": "Schindler's List",
      "operation": "INSERT",
      "embedding": "[-0.00048090287600643933, 0.08829884976148605, 0.039303574711084366, 0.05460181087255478, 0.021626191213726997, 0.006314448546618223, -0.010663907043635845, -0.009180179797112942, -0.0006963423220440745, -0.010473274625837803, -0.03609679266810417, 0.008081375621259212, -0.008863487280905247, 0.010080649517476559, -0.05743522569537163, 0.0024443583097308874, -0.008024889975786209, -0.03492895886301994, 0.011219168081879616, 0.015769589692354202, 0.009350982494652271, 0.009198026731610298, 0.018079791218042374, 0.0030097237322479486, -0.004095179028809071, 0.04826447367668152, -0.047186288982629776, -0.03943547233939171, -0.045859117060899734, 0.04718412458896637, 0.008613592013716698, -0.013953577727079391, -1.4384626410901546e-05, -0.048996370285749435, 0.04785819351673126, 0.07098142057657242, 0.015618514269590378, 0.016713004559278488, -0.04282889887690544, -0.04360179230570793, -0.0005983018199913204, 0.022301428020000458, 0.023287994787096977, 0.006518719717860222, -0.06055840477347374, 0.027115575969219208, -0.06667632609605789, -0.0712444931268692, 0.05324983596801758, 0.0077286274172365665, -0.06104658916592598, -0.0543987974524498, -0.07975836843252182, -0.024967504665255547, -0.06014706939458847, -0.02074662782251835, -0.07662999629974365, -0.08837009221315384, -0.03690630942583084, -0.04276662692427635, 0.03444889932870865, -0.11492684483528137, -0.007660357281565666, 0.013170111924409866, 0.002277602208778262, -0.04962615668773651, -0.05634811148047447, 0.022494424134492874, -0.0066947233863174915, -0.046006783843040466, -0.018648410215973854, 0.010820208117365837, 0.011304658837616444, 0.04875641316175461, 0.08986493945121765, 0.04330442473292351, 0.03669144585728645, -0.014111471362411976, -0.07731927186250687, 0.044762346893548965, 0.07631449401378632, -0.07544956356287003, -0.08505571633577347, -0.02018776722252369, 0.034836120903491974, -0.02617797441780567, 0.009551814757287502, -0.0010325877228751779, -0.003658345900475979, -0.0737001821398735, -0.03756426274776459, 0.020415252074599266, 0.07592019438743591, -0.05362017825245857, -0.006429516710340977, 0.1453717201948166, -0.005189036019146442, -0.06786837428808212, -0.056073613464832306, -0.08530950546264648, -0.00928051583468914, -0.01191280223429203, -0.022007277235388756, -0.012804503552615643, -0.006537155713886023, -0.00320665561594069, -0.058370500802993774, 0.10881862789392471, 0.03774170204997063, 0.030516263097524643, -0.012093739584088326, 0.0940122976899147, -0.033305518329143524, 0.02142000012099743, 0.02818433940410614, -0.02744835987687111, -0.046458899974823, 0.01780444011092186, 0.06558975577354431, -0.017512628808617592, 0.018912645056843758, 0.038868341594934464, -0.0706319659948349, -0.03989247977733612, 0.04382355511188507, 0.07442338764667511, 0.026909245178103447, -0.045700497925281525, -0.013905989937484264, 0.016914810985326767, 0.0002752342261373997, 0.015265660360455513, -0.058532580733299255, 0.006208278704434633, 0.04614662006497383, 0.05410539731383324, 0.00853823870420456, -0.04768865182995796, -0.07442998886108398, -0.06870130449533463, 0.018933657556772232, -0.030411647632718086, -0.024175800383090973, -0.05147606134414673, -0.01677303947508335, 0.08575989305973053, -0.0119481785222888, 0.04421425238251686, -0.0911286473274231, 0.04119836539030075, 0.04655127972364426, 0.047453757375478745, 0.013216803781688213, 0.011541787534952164, -0.0053570508025586605, 0.02762979455292225, 0.03845389559864998, 0.01410891767591238, 0.07375200092792511, 0.01217096857726574, -0.06705431640148163, 0.0033011222258210182, -0.06449542939662933, 0.04830747842788696, -0.020873133093118668, -0.016664480790495872, 0.03983177989721298, -0.03701766952872276, 0.007159566041082144, 0.01202778797596693, -0.11248695850372314, 0.0689915120601654, -0.097316674888134, -0.05330784618854523, 0.0052962759509682655, 0.003456291975453496, -0.016889875754714012, -0.04368577525019646, 0.004196858499199152, 0.04010123386979103, 0.06009114161133766, 0.058284178376197815, -0.06630075722932816, 0.04714324325323105, -0.05280302092432976, 0.07767144590616226, -0.042902622371912, 0.0063904873095452785, 0.02284996770322323, 0.04835014417767525, -0.05176672339439392, -0.05170591548085213, 0.03682417422533035, -0.0458584800362587, -0.0487072728574276, -0.016954783350229263, 0.08070088922977448, 0.03809086233377457, 0.04953423887491226, -0.02865852229297161, -0.05749313160777092, -0.06535309553146362, -0.03826957568526268, 0.003231041133403778, 0.06089736148715019, -0.01998630352318287, -0.066114142537117, -0.0834273025393486, -0.019455378875136375, -0.040523309260606766, -0.0456940196454525, -0.0682612806558609, 0.014478464610874653, -0.0065739634446799755, -0.007286686450242996, -0.014627519994974136, -0.01829514466226101, -0.032755862921476364, 0.04548177495598793, -0.01870696432888508, -0.022892216220498085, -0.026203325018286705, 0.013296538963913918, -0.02846282161772251, 0.032015375792980194, -0.04310360178351402, -0.019893592223525047, -0.017327236011624336, 0.08695878833532333, -0.004351715091615915, -0.05486755445599556, -0.035354189574718475, 0.032719701528549194, 0.028394917026162148, 0.06637077033519745, 0.007496804930269718, -0.011290520429611206, -0.04934263974428177, 0.05872724577784538, 0.08344104140996933, 0.015639834105968475, -8.904002606868744e-05, 0.028340255841612816, -0.008924007415771484, -0.06862255185842514, -0.06545794010162354, -0.03963237255811691, 0.04738912358880043, 0.004941602237522602, 0.014382625930011272, -0.015514588914811611, -0.001369637087918818, 0.0025891063269227743, -0.017568698152899742, 0.03085998445749283, -0.05068585276603699, -0.010788298211991787, 0.06591206789016724, -0.046153053641319275, 0.025929044932127, -0.008875739760696888, 0.016701189801096916, -0.03403739631175995, 0.01869296096265316, 0.020763970911502838, 0.029668021947145462, -0.02743075042963028, 0.00587003817781806, 0.010374021716415882, -0.005168354604393244, -0.033530909568071365, 0.01834440976381302, -0.06983611732721329, -0.012591637670993805, -0.017893966287374496, -4.184991121292114e-05, 0.06621548533439636, 0.029200978577136993, 0.014782187528908253, 0.021210476756095886, 0.03146414831280708, -0.014538458548486233, -0.019574929028749466, 0.02862304262816906, -0.06120995432138443, -0.02325940690934658, 0.020226579159498215, 0.048623695969581604, 0.06869401782751083, -0.04448871314525604, -0.06059883162379265, 0.018751783296465874, -0.04005635529756546, -0.014295544475317001, 0.008955261670053005, -0.021385876461863518, -0.019800784066319466, -0.014961827546358109, -0.014569658786058426, 0.03578343614935875, -0.011041205376386642, 0.006332756951451302, -0.00645605381578207, 0.05638645589351654, -0.007101419381797314, -0.025304481387138367, 0.0385616272687912, 0.0561259426176548, -0.0036190543323755264, 0.02879590541124344, 0.01795063726603985, 0.023177415132522583, 0.0705932006239891, 0.02485182136297226, 0.018976353108882904, 0.018053697422146797, -0.013507489114999771, -0.026526764035224915, 0.05821724236011505, 0.06472691148519516, 0.03911644220352173, -0.031235871836543083, 0.04297312721610069, -0.007058073300868273, 0.021154601126909256, 0.017314642667770386, -0.06346245855093002, -0.030777277424931526, -0.019404804334044456, -0.006861667148768902, -0.07512923330068588, 0.08450929820537567, -0.07617338746786118, 0.002669727662578225, 0.032868918031454086, 0.005563313607126474, -0.04856332018971443, 0.039999909698963165, 0.015022385865449905, -0.009641747921705246, -0.0380672886967659, 0.043074462562799454, 0.03540147840976715, -0.019074827432632446, -0.00856656301766634, 0.009047606959939003, -0.06326302886009216, -0.03479459509253502, -0.023524945601820946, 0.016889389604330063, -0.07342325150966644, 0.01814454235136509, -0.010843433439731598, -0.03435652703046799, -0.022851768881082535, -0.04068474844098091, -0.013044176623225212, -0.0035750644747167826, -0.024647094309329987, 0.042233411222696304, -0.00705192843452096, -0.0810554251074791, 0.0068382686004042625, 0.020352739840745926, -0.035418469458818436, -0.030972326174378395, 0.019079318270087242, 0.03557749465107918, 0.006220727227628231, 0.025877507403492928, 0.01665152609348297, 0.011592753231525421, 0.027855195105075836, 0.016921663656830788, 0.01863928884267807, -0.10016602277755737, 0.04045119509100914, 0.0248789694160223, -0.044993702322244644, 0.013643837533891201, 0.05523199588060379, 0.02661781944334507, -0.025669287890195847, -0.017031846567988396, 0.068027064204216, -0.02276518940925598, 0.05980220437049866, 0.04229367524385452, -0.01954771764576435, -0.01967020146548748, 0.0484887957572937, -0.04493436962366104, -0.07656392455101013, -0.004326127003878355, -0.03144204989075661, 0.006558053661137819, -0.011293712072074413, -0.014180912636220455, -0.02320754900574684, -0.047491636127233505, 0.06528165936470032, 0.04512955620884895, -0.0024979603476822376, -0.03178177401423454, 0.01598167046904564, -0.03969913348555565, -0.05445928871631622, 0.010207508690655231, -0.05850644037127495, 0.03607926517724991, 0.06074133887887001, 0.020571378991007805, 0.0021412926726043224, -0.001249178545549512, 0.031289685517549515, -0.03084404580295086, 0.03671460226178169, 0.010904422961175442, 0.0010163869010284543, -0.011046286672353745, -0.012570244260132313, -0.06276246160268784, -0.08045610040426254, -0.0045698294416069984, -0.0385618731379509, -0.06699055433273315, -0.0549190528690815, 0.012965498492121696, 0.07675576955080032, 0.047987572848796844, 0.017711741849780083, -0.04747096821665764, 0.11710347980260849, 0.01593448594212532, 0.01719522476196289, -0.013853181153535843, -0.03846566751599312, 0.030603254213929176, 0.017413703724741936, 0.011928441002964973, -0.01552571915090084, -0.08293575793504715, 0.030221501365303993, -0.003011097898706794, -0.042452726513147354, 0.0024585530627518892, 0.02960197441279888, 0.026208920404314995, 0.021835755556821823, -0.013887901790440083, 0.028330251574516296, -0.003871901659294963, -0.02514163963496685, -0.01432029902935028, -0.008416814729571342, 0.051649730652570724, -0.018312400206923485, 0.004572604782879353, -0.0015735005727037787, -0.007291556801646948, 0.05236916244029999, 0.012995978817343712, -0.040901679545640945, -0.013277932070195675, 0.018052462488412857, -0.018980907276272774, -0.08287260681390762, -0.01570414938032627, -0.03628126159310341, -0.09093725681304932, -0.03105955384671688, -0.05856792628765106, 0.06585191935300827, -0.023591963574290276, -0.06187020614743233, 0.0601777657866478, -0.060626015067100525, 0.005076349712908268, -0.0009220390347763896, 0.03322294354438782, 0.0319269597530365, -0.021560868248343468, 0.03580251708626747, 0.011660410091280937, -0.0751100704073906, -0.019083237275481224, -0.051724519580602646, 0.0036903261207044125, 0.045055683702230453, 0.0014132768847048283, 0.025584980845451355, -0.05216424912214279, -0.03031277097761631, -0.014508957043290138, 0.0016129502328112721, 0.0577525831758976, 0.006188106723129749, 0.06000480428338051, 0.022249413654208183, -0.07414219528436661, 0.06353696435689926, 0.009587162174284458, -0.01468636840581894, 0.006289315409958363, 0.042827047407627106, 0.003428819589316845, -0.03455434739589691, 0.0012184729566797614, -0.03764665126800537, -0.03000567853450775, -0.0517674945294857, 0.010911119170486927]"
    },
    {
      "_id": 2,
      "database": "unit_test",
      "index_id": "test_index_id",
      "primary_key_name": "_id",
      "primary_key_value": "2",
      "column_name": "title",
      "column_value": "Inception",
      "operation": "INSERT",
      "embedding": "[-0.033594898879528046, -0.02255389839410782, -0.05276608467102051, 0.009748801589012146, -0.0757564827799797, 0.04332639276981354, -0.00032768514938652515, -0.03533371165394783, -0.034178633242845535, -0.06170124188065529, -0.05128972977399826, 0.06557450443506241, -0.013947177678346634, 0.020854806527495384, 0.0049615115858614445, -0.03119600936770439, 0.050612494349479675, -0.037461426109075546, 0.022857822477817535, -0.029459143057465553, -0.03562512993812561, 0.05337555333971977, 0.02302733063697815, 0.014202684164047241, -0.04070489481091499, 0.011626113206148148, -0.0003775700170081109, -0.011293506249785423, -0.0448911227285862, 0.0010796901769936085, 0.03950070962309837, 0.027907855808734894, -0.01933613047003746, -0.0172684695571661, 0.00863869022578001, -0.0027783396653831005, -0.02909615822136402, -0.007709404453635216, 0.07309010624885559, -0.018116740509867668, 0.009965002536773682, -0.006284449715167284, 0.02136159874498844, -0.048349734395742416, -0.014320912770926952, 0.0008393757161684334, -0.022600719705224037, -0.042442165315151215, 0.029652075842022896, 0.04198615625500679, 0.025724247097969055, -0.008003144524991512, -0.03069158084690571, -0.048464108258485794, -9.550992399454117e-05, 0.03827075660228729, 0.023147262632846832, 0.09611982107162476, 0.02390165440738201, 0.009756995365023613, 0.016272973269224167, 0.022665580734610558, 0.0072134449146687984, 0.01881430111825466, 0.02314225398004055, 0.019468847662210464, -0.0012728222645819187, -0.016191856935620308, 0.07006360590457916, -0.040075600147247314, 0.06242801621556282, 0.011096082627773285, 0.048724520951509476, -0.015328525565564632, 0.024633461609482765, -0.03240340203046799, 0.020773565396666527, 0.028465980663895607, 0.02845495566725731, 0.013098625466227531, -0.018774282187223434, -0.05007098987698555, -0.17564629018306732, 0.015193913131952286, -0.01865270733833313, -0.017466196790337563, -0.005051278043538332, -0.00018957071006298065, 0.005179114174097776, -0.012678108178079128, -0.03499694541096687, 0.014649688266217709, -0.15235336124897003, 0.018386250361800194, -0.007867658510804176, 0.16566729545593262, -0.06207256019115448, -0.047496553510427475, 0.07904141396284103, -0.007152091711759567, -0.04089556634426117, 0.012229965068399906, 0.021025335416197777, 0.022429632022976875, -0.06623494625091553, -0.006091637536883354, 0.05407455936074257, 0.039606042206287384, -0.005374420899897814, -0.0037289983592927456, -0.007673007436096668, 0.13398760557174683, -0.022799624130129814, 0.043846722692251205, 0.11127743124961853, -0.05410520359873772, 0.08172164112329483, -0.04879649728536606, 0.05767340585589409, 0.017850182950496674, 0.0031869271770119667, -0.050163231790065765, -0.02836971916258335, -0.012795761227607727, 0.034843482077121735, -0.04399096965789795, -0.0039851246401667595, -0.01593736931681633, -0.01069958508014679, -0.005335615947842598, 0.02946089394390583, 0.06511218845844269, -0.048488833010196686, -0.006713441107422113, 0.054064057767391205, 0.046635981649160385, 0.03482704609632492, -0.00785499345511198, 0.011879987083375454, -0.06700058281421661, 0.029581405222415924, 0.024573389440774918, 0.0014935990329831839, 0.02035052515566349, -0.010376445017755032, -0.005698344670236111, -0.021818451583385468, 0.010048951022326946, 0.03031277284026146, 0.024085966870188713, 0.005377716850489378, 0.05880395323038101, -0.030499406158924103, -0.015352853573858738, -0.07096303999423981, -0.023121919482946396, 0.007273248862475157, -0.0018880275310948491, 0.0387386679649353, 0.0367661751806736, 0.017422562465071678, -0.06654339283704758, -0.08265233039855957, -0.04338536784052849, -0.01341080479323864, 0.0011428873986005783, 0.038975704461336136, -0.025310149416327477, 0.01627257466316223, -0.028290968388319016, -0.12360097467899323, 0.13933978974819183, -0.04894435405731201, 0.008230501785874367, -0.020477328449487686, 0.03141381964087486, 0.01089646015316248, -0.05704484507441521, -0.014690149575471878, -0.018258072435855865, 0.047192756086587906, -0.08147415518760681, -0.06558486819267273, -0.014117096550762653, -0.05170093849301338, 0.0014740986516699195, 0.017859643325209618, -0.03625187650322914, 0.03914119303226471, -0.0715002566576004, -0.004125429317355156, 0.05786026269197464, 0.09629765897989273, -0.034994203597307205, -0.028893401846289635, -0.028401682153344154, -0.027407441288232803, 0.06256968528032303, -0.047375455498695374, -0.04288385808467865, 0.0634208619594574, -0.10570307821035385, -0.034832943230867386, -0.019339105114340782, -0.04753115400671959, 0.020885251462459564, -0.08819485455751419, -0.05280742421746254, -0.06299298256635666, -0.03967321664094925, -0.02380841225385666, -0.0026407046243548393, 0.020512113347649574, 0.07391829788684845, -0.01060445699840784, -0.015175295062363148, 0.008826112374663353, 0.07900364696979523, 0.021712344139814377, 0.07603523880243301, -0.01500247698277235, -0.04405125975608826, 0.04598359391093254, 0.02560054138302803, 0.01905754581093788, 0.01064338069409132, -0.036736004054546356, -0.015398059040307999, 0.038162313401699066, -0.03798022121191025, -0.06515637785196304, 0.04165623337030411, 0.014434512704610825, -0.011557062156498432, 0.001342141767963767, -0.027349421754479408, -0.02638564445078373, -0.014831731095910072, 0.019784491509199142, 0.10126078128814697, -0.013826552778482437, -0.008825032040476799, -0.033193089067935944, -0.009277842938899994, -0.027155619114637375, 0.07617499679327011, 0.0893668457865715, 0.031955841928720474, 0.021636443212628365, 0.021148985251784325, 0.009601923637092113, -0.008706916123628616, -0.03536703437566757, -0.008514832705259323, -0.04765509441494942, 0.0001508196583017707, -0.017408382147550583, -0.043879784643650055, -0.026838501915335655, 0.04405263811349869, 0.014743461273610592, 0.02372881770133972, 0.013947637751698494, 0.03745543584227562, -0.031192397698760033, 0.011419308371841908, 0.003970918711274862, 0.04278963431715965, 0.025574401021003723, 0.019455593079328537, 0.0033408591989427805, 0.04706795513629913, 0.019590456038713455, -0.06847216188907623, 0.031937625259160995, -0.06585289537906647, 0.01980564184486866, 0.05333225056529045, 0.03017798624932766, 0.07499097287654877, -0.006676855497062206, 0.04401783645153046, 0.024747608229517937, 0.01729981042444706, -0.003700794419273734, -0.06855335831642151, 0.011365913785994053, -0.002980872057378292, 0.0045350114814937115, -0.02746637910604477, -0.03440389037132263, -0.017650803551077843, -0.05255422368645668, -0.015449024736881256, 0.017344489693641663, -0.014649230055510998, 0.01176587212830782, -0.03247245028614998, -0.007177683990448713, 0.030534714460372925, 0.05771184340119362, 0.10138112306594849, -0.01551686879247427, -0.003784522181376815, 0.027338556945323944, 0.0310545451939106, 0.00823390856385231, 0.06120461970567703, -0.018693501129746437, -0.022248078137636185, 0.03453120216727257, -0.0200484748929739, 0.06484188139438629, -0.07063025236129761, 0.04673127457499504, -0.028743157163262367, 0.015170302242040634, -0.005171960685402155, -0.01575358957052231, -0.02434498816728592, 0.028610287234187126, -0.024678848683834076, 0.012282688170671463, 0.029485885053873062, 0.0176111850887537, 0.03676621615886688, -0.042919665575027466, -0.02721869945526123, -0.052976422011852264, -0.03662349283695221, -0.02302626147866249, 0.05223451182246208, -0.03689286485314369, -0.02061377838253975, -0.029341701418161392, 0.026137592270970345, 0.026367971673607826, 0.03538899123668671, 0.04336116090416908, 0.026952864602208138, -0.07270379364490509, -0.024298617616295815, -0.013988633640110493, 0.028922349214553833, 0.032816290855407715, 0.006015276536345482, -0.020766928791999817, 0.0011687740916386247, 0.017538469284772873, 0.015886366367340088, -0.022811856120824814, -0.018120678141713142, -0.04916274920105934, 0.0485963337123394, -0.0574326254427433, -0.014161421917378902, -0.03937745839357376, 0.04048929363489151, -0.027585214003920555, 0.029110237956047058, -0.017614932730793953, -0.017960762605071068, 0.025027863681316376, 0.020759116858243942, 0.0328938253223896, 0.026990162208676338, -0.031175918877124786, -0.006851173937320709, 0.004730447195470333, 0.04484083876013756, 0.019914962351322174, -0.03308134153485298, -0.002207227284088731, 0.01578338071703911, -0.03618010878562927, -0.009039195254445076, -0.01031943503767252, 0.06833560019731522, -0.029175084084272385, 0.04420974478125572, 0.04278487339615822, -0.04172052443027496, -0.009840892627835274, 0.006272830534726381, 0.011891000904142857, 0.02427675761282444, -0.01943398080766201, -0.007132291793823242, 0.022723611444234848, -0.06776969134807587, -0.028858015313744545, 0.019134212285280228, -0.0023094285279512405, -0.008076517842710018, 0.022923385724425316, -0.09298698604106903, 0.027444813400506973, -0.009381851181387901, 0.08175121247768402, -0.014229011721909046, 0.013185106217861176, -0.02889695204794407, -0.036084745079278946, 0.017573274672031403, 0.054570045322179794, -0.019624678418040276, -0.020901093259453773, 0.07086645811796188, -0.00040076588629744947, -0.010166136547923088, 0.07910788804292679, 0.014719649218022823, 0.041030071675777435, -0.06885386258363724, 0.04920041188597679, 0.02644176222383976, -0.0074411435052752495, -0.006640981882810593, 0.011117836460471153, -0.030543887987732887, -0.059398453682661057, -0.04753917083144188, 0.0041763801127672195, 0.08954837173223495, -0.04792216420173645, -0.006648470647633076, -0.016097618266940117, -0.004220845643430948, 0.03731686621904373, -0.016760574653744698, 0.03611038997769356, 0.04182281717658043, -0.07901004701852798, -0.0034400573931634426, -0.012401715852320194, 0.04867485165596008, 0.054192882031202316, 0.008643568493425846, 0.005691368132829666, 0.0069013177417218685, 0.04635271802544594, -0.2145276814699173, -0.02551085129380226, -0.015853464603424072, -0.011810213327407837, 0.0323699489235878, -0.021690836176276207, -0.0002647414803504944, 0.0033413434866815805, 0.01145249418914318, -0.007923923432826996, 0.024738742038607597, -0.07087437808513641, 0.029849760234355927, -0.02367120236158371, 0.06099522486329079, -0.06351707875728607, 0.02951733209192753, -0.024760020896792412, -0.04436656832695007, 0.051454298198223114, -0.04321710392832756, 0.01942107267677784, -0.04468393325805664, -0.04166201129555702, -0.04224947839975357, -0.0010639422107487917, 0.05191664770245552, 0.020066240802407265, 0.002432315843179822, 0.012821721844375134, 0.038107529282569885, 0.018807074055075645, -0.05148608237504959, 0.014888528734445572, 0.008139044977724552, 0.04610587656497955, 0.015352538786828518, 0.02340427227318287, 0.017388606444001198, -0.04143381118774414, -0.023762255907058716, 0.09009884297847748, -0.05367932841181755, -0.04567493498325348, -0.04693670570850372, -0.006752444431185722, 0.016876304522156715, 0.05602171644568443, 0.011432682164013386, 0.02436787262558937, -0.0005566458567045629, 0.04618890956044197, 0.02474672719836235, 0.005471184849739075, -0.019359441474080086, -0.02038341760635376, 0.0005140782450325787, 0.01966952718794346, -0.07372540980577469, -0.025973917916417122, 0.015883782878518105, -0.008962470106780529, -0.0033353054895997047, -0.06291107833385468, 0.0011324556544423103, -0.039218463003635406, -0.07139070332050323, 0.020805900916457176, -0.0015592410927638412, -0.008101699873805046, -0.02941453829407692]"
    },
    {
      "_id": 3,
      "database": "unit_test",
      "index_id": "test_index_id",
      "primary_key_name": "_id",
      "primary_key_value": "3",
      "column_name": "title",
      "column_value": "Fight Club",
      "operation": "INSERT",
      "embedding": "[-0.025350339710712433, 0.009165766648948193, -0.0006264745607040823, -0.00014192378148436546, -0.030956819653511047, 0.02091195434331894, 0.02735385298728943, -0.06803916394710541, 0.054914478212594986, 0.02296779677271843, 0.02627076394855976, -0.07965370267629623, -0.038620054721832275, 0.08544053882360458, 0.020159179344773293, -0.059880081564188004, -0.03855511546134949, -0.06628689914941788, 0.08936797827482224, 0.021265501156449318, 0.06232370063662529, 0.006597235798835754, 0.06961575150489807, 0.0008275339496321976, -0.004794718697667122, 0.041804589331150055, 0.03791398927569389, -0.0026456897612661123, 0.01810452714562416, 0.030520044267177582, 0.021787265315651894, 0.07535512745380402, -0.014090200886130333, -0.011297633871436119, -0.03175598010420799, 0.05822481960058212, -0.01073022186756134, 0.0022584404796361923, -0.04732263460755348, -0.020834827795624733, 0.001855822280049324, -0.04938624054193497, 0.00923387985676527, -0.04318978264927864, 0.03306901827454567, -0.010411680676043034, 0.062476225197315216, -0.0022835079580545425, 0.09953214228153229, 0.02627718448638916, -0.034765638411045074, 0.020478254184126854, -0.03895340487360954, -0.07134413719177246, -0.0025695948861539364, 0.03004704788327217, -0.022032007575035095, 0.0009484512847848237, -0.036795616149902344, 0.04311076179146767, -0.012904777191579342, -0.12729333341121674, 0.11912243813276291, -0.021490387618541718, -0.026747671887278557, 0.03905680403113365, 0.03626527637243271, -0.04780321568250656, -0.006377261132001877, -0.0157945454120636, -0.007610429544001818, -0.01179552637040615, 0.012570464052259922, -0.006321655120700598, 0.0162845216691494, 0.06775408983230591, 0.03155352920293808, 0.02987467683851719, -0.07878874242305756, 0.007848487235605717, 0.004623573739081621, -0.08048205077648163, -0.06637931615114212, -0.03392279893159866, 0.010499496012926102, 0.009722955524921417, -0.026035841554403305, -0.024597030133008957, -0.001332813990302384, 0.12744446098804474, 0.023902645334601402, 0.0013230160111561418, -0.01100431103259325, -0.03368606045842171, -0.017148882150650024, 0.12960205972194672, 0.008032643236219883, -0.04772578552365303, 0.016571661457419395, -0.002062754472717643, -0.02795143611729145, -0.03330180421471596, 0.06889951229095459, 0.03919132798910141, 0.014985649846494198, 0.031301386654376984, -0.041840504854917526, -0.010349608026444912, 0.006976919714361429, -0.017934327945113182, -0.01879088208079338, 0.09486278146505356, -0.046666961163282394, -0.011422705836594105, 0.023057322949171066, -0.05977264791727066, -0.032518159598112106, -0.0730930045247078, 0.033232856541872025, 0.04154234379529953, 0.024180961772799492, -0.03979207202792168, 0.019869299605488777, -0.06428758054971695, 0.00014848809223622084, 0.06927426159381866, -0.01744372956454754, -0.03232137858867645, 0.010139311663806438, 0.010764987207949162, -0.000354661577148363, 0.009677616879343987, -0.00010055303573608398, -0.026044290512800217, -0.003403868991881609, -0.025455128401517868, -0.009011389687657356, 0.009604685939848423, -0.0259095411747694, -0.06087994575500488, 0.05458864942193031, 0.03229609131813049, -0.03402569890022278, 0.006174328736960888, -0.04318908601999283, 0.009532174095511436, -0.01679025962948799, 0.024154575541615486, -0.0036288858391344547, 0.009463130496442318, -0.030154727399349213, 0.02941819280385971, -0.04475746303796768, 0.08053328841924667, 0.017085282132029533, 0.013355645351111889, -0.013747288845479488, -0.004914766177535057, 0.007362760603427887, -0.01341799646615982, 0.0016073365695774555, 0.004661846440285444, -0.029869364574551582, -0.02082548290491104, 0.022989893332123756, 0.07107002288103104, 0.03939391300082207, -0.05158710107207298, -0.006306431256234646, -0.04745692387223244, -0.08231555670499802, 0.08149892836809158, -0.041917670518159866, 0.006026771850883961, 0.0563112236559391, 0.004195414017885923, -0.0028029035311192274, -0.03920431807637215, -0.059970930218696594, -0.01771600730717182, 0.08797883987426758, 0.057788580656051636, -0.05002567917108536, -0.0032051156740635633, -0.04362952709197998, 0.03375811502337456, -0.0007433619466610253, -0.03589877858757973, -0.03372269868850708, -0.023815546184778214, -0.028440119698643684, -0.06289501488208771, 0.07278373092412949, 0.004906866233795881, -0.05705352500081062, -0.07881364971399307, -0.007664320059120655, -0.041638102382421494, 0.042285993695259094, 0.02084294520318508, 0.0017422422533854842, -0.0807543620467186, -0.03195181116461754, -0.05777733772993088, 0.04002244025468826, -0.061686813831329346, -0.01573115587234497, 0.027662524953484535, 0.03186466544866562, -0.024280037730932236, 0.021198222413659096, -0.04776192456483841, 0.03384361043572426, 0.07914907485246658, 0.0033763626124709845, -0.025600075721740723, 0.049811068922281265, -0.01097045000642538, 0.0031577039044350386, -0.06185274198651314, 0.04697667062282562, -0.014856209978461266, 0.05845724418759346, -0.03862161934375763, -0.04802924767136574, -0.06251101940870285, 0.01072779856622219, -0.0316455103456974, 0.005550968926399946, 0.0040080612525343895, -0.07015074044466019, -0.013551166281104088, -0.083729088306427, 0.05603742599487305, 0.0170873012393713, -0.0009168402757495642, -0.04056355729699135, -0.06574088335037231, 0.03494827449321747, 0.08486294746398926, 0.017433028668165207, -0.0103799719363451, 0.0584215447306633, 0.008454814553260803, 0.012542543932795525, 0.037587862461805344, -0.06285664439201355, -0.007125413976609707, -0.018970387056469917, 0.07559771090745926, -0.0035595588851720095, 0.02057340182363987, 0.00673629017546773, 0.01521683856844902, 0.02534247376024723, 0.02551700361073017, -0.015121782198548317, 0.0037133919540792704, -0.020276756957173347, 0.019231995567679405, 0.008902573958039284, 0.036219943314790726, 0.042221538722515106, 0.009549037553369999, 0.026494920253753662, -0.00032822974026203156, -0.004734784364700317, -0.005654460284858942, 0.030147401615977287, 0.013918347656726837, -0.023150237277150154, 0.009564965032041073, -0.02870294451713562, -0.02420620806515217, 0.08259156346321106, 0.052266694605350494, -0.1418173611164093, -0.005959768779575825, 0.002054674783721566, 0.009784961119294167, -0.08477819710969925, 0.027176063507795334, 0.009643244557082653, -0.06309492141008377, 0.0007679051486775279, -0.020630013197660446, -0.015256935730576515, -0.036781225353479385, -0.018605496734380722, 0.027649305760860443, -0.0332111157476902, 0.06011182814836502, -0.004960753954946995, 0.013277022168040276, 0.015363155864179134, -0.012153544463217258, -0.03819853812456131, -0.04509003832936287, -0.03969031572341919, -0.0443432480096817, -0.07290326803922653, -0.009673883207142353, 0.023106703534722328, -0.00422352459281683, 0.03522641211748123, 0.026980677619576454, 0.027817102149128914, 0.05633028969168663, -0.05363903194665909, 0.009423722513020039, -0.010057268664240837, 0.049000076949596405, -0.014649203047156334, 0.010207927785813808, 0.009972223080694675, 0.012468959204852581, 0.03997963294386864, 0.011924698017537594, 0.017789285629987717, 0.007779690902680159, 0.028552353382110596, -0.06019246578216553, -0.01999778300523758, -0.01894681341946125, -0.02929839864373207, 0.014355216175317764, -0.014448162168264389, 0.018311019986867905, -0.0693851038813591, -0.028322553262114525, 0.004002910107374191, 0.041862379759550095, -0.009571019560098648, -0.026607858017086983, 0.04616279900074005, 0.023634610697627068, 0.0021956567652523518, 0.010221131145954132, 0.007726387120783329, -0.022481996566057205, 0.0013898378238081932, -0.06358461827039719, 0.00611910130828619, -0.04201974347233772, 0.027144329622387886, -0.002809058176353574, -0.06527898460626602, -0.06613943725824356, -0.007859505712985992, -0.006027377676218748, 0.040220681577920914, -0.028469856828451157, -0.08401988446712494, -0.005979841575026512, -0.027243325486779213, -0.03710039332509041, 0.028989441692829132, 0.029279526323080063, 0.021773546934127808, -0.015131935477256775, 0.0014618380228057504, -0.02040960267186165, -0.019077081233263016, -0.053764041513204575, 0.09432864189147949, 0.027168022468686104, -0.029766477644443512, 0.0726076290011406, 0.00802488811314106, -0.0034431612584739923, 0.02291504666209221, 0.10567183047533035, -0.026853490620851517, -0.04111657664179802, -0.061685312539339066, -0.02791202999651432, 0.03705142065882683, -0.009012069553136826, -0.07665859162807465, -0.028496121987700462, 0.027671370655298233, 0.057488132268190384, -0.015345015563070774, 0.08182882517576218, 0.0481283999979496, -0.02916460484266281, -0.002689217682927847, 0.04317944869399071, -0.04662369191646576, -0.0591292642056942, 0.024318190291523933, 0.009304706007242203, 0.029577260836958885, 0.044868819415569305, -0.02310989238321781, 0.03462214395403862, 0.06550078839063644, -0.05705857649445534, 0.07593756169080734, -0.01748034358024597, -0.0006825475720688701, -0.03129380941390991, -0.033997658640146255, -0.004045567009598017, -0.0437588095664978, -0.054051723331213, -0.01639130525290966, 0.031530819833278656, 0.04151527211070061, -0.01769593358039856, 0.0781121477484703, -0.025698626413941383, -0.06400103121995926, -0.051556408405303955, 0.040537673979997635, 0.06775622069835663, -0.01306360587477684, -0.019221235066652298, 0.0015773848863318563, 0.013420325703918934, 0.009130853228271008, -0.021379195153713226, 0.015235958620905876, 0.02080788090825081, -0.045302338898181915, -0.07851286977529526, 0.008780550211668015, 0.040160588920116425, -0.08516570925712585, -0.06385451555252075, -0.018522856757044792, -0.013470691628754139, 0.008074654266238213, -0.01093566045165062, 0.0019082510843873024, 0.018233556300401688, 0.0012043517781421542, 0.024847641587257385, -0.020541423931717873, 0.049832697957754135, -0.05008649080991745, -0.09353937953710556, 0.0029378063045442104, 0.07552053034305573, -0.08470243960618973, 0.02076944336295128, -0.028148947283625603, -0.06348440796136856, -0.008892491459846497, -0.027830401435494423, -0.016522878780961037, -0.06852956116199493, 0.019845260307192802, 0.03236308693885803, -0.027065880596637726, 0.03877876698970795, 0.011864555068314075, 0.02959899976849556, 0.10070692747831345, -0.06485507637262344, 0.04265419393777847, -0.02219674549996853, -0.022493993863463402, -0.02544822171330452, -0.036315202713012695, -0.026599576696753502, 0.02838517539203167, 0.007550570648163557, 0.024882735684514046, -0.04751697555184364, -0.010264179669320583, 0.020341139286756516, -0.021020708605647087, -0.015175959095358849, 0.03760053589940071, 0.02614527940750122, -0.059096939861774445, -0.015564716421067715, 0.03163639083504677, -0.08827415108680725, -0.008687141351401806, 0.005772607401013374, 0.08787653595209122, -0.051078058779239655, 0.010921495966613293, 0.03629034385085106, -0.08129670470952988, -0.030013272538781166, -0.006196584552526474, 0.002562542911618948, 0.01059406902641058, 0.0068583921529352665, -0.011229697614908218, -0.00940741691738367, 0.018259402364492416, -0.06140054762363434, -0.0018635938176885247, 0.04408460482954979, 0.03342297300696373, -0.06906727701425552, -0.01914665848016739, -0.08791302144527435, 0.04807685688138008, 0.054572053253650665, 0.10558120161294937, 0.02700640633702278, 0.045585211366415024, 0.027159640565514565, 0.043523434549570084, 0.048843298107385635, 0.012135758996009827, 0.004531622398644686]"
    }]"""

    JSON_IMAGE_ITEMS = """
    [
      {
      "_id": 1,
      "database": "unit_test",
      "index_id": "test_image_index_search",
      "primary_key_name": "_id",
      "primary_key_value": "1",
      "column_name": "image",
      "column_value": "https://cdn-v4.petpetgo.com/940/public/54185639-5747-4718-bcb4-287b8c6ab8a0.jpg",
      "operation": "INSERT"
      },   
      {
      "_id": 2,
      "database": "unit_test",
      "index_id": "test_image_index_search",
      "primary_key_name": "_id",
      "primary_key_value": "2",
      "column_name": "image",
      "column_value": "https://cdn-v4.petpetgo.com/600/public/333311c4-c5eb-48a7-a742-6750d9eb00a3.jpg",
      "operation": "INSERT"
      },  
      {
      "_id": 3,
      "database": "unit_test",
      "index_id": "test_image_index_search",
      "primary_key_name": "_id",
      "primary_key_value": "3",
      "column_name": "image",
      "column_value": "https://cdn-v4.petpetgo.com/940/public/d26ceaf5-2cf7-4484-b19e-de753641f600.jpg",
      "operation": "INSERT"
      }   
    ]
    """

    def test_normal_inserts(self):
        items = json.loads(self.JSON_TEXT_ITEMS)
        df = FaissPipeline().write("unit_test", "test_normal_inserts", items)
        print(df.head)
        self.assertEqual(len(items), len(df))

    def test_remove(self):
        items = json.loads(self.JSON_TEXT_ITEMS)
        items[2]["primary_key_value"] = "1"
        items[2]["operation"] = "DELETE"
        df = FaissPipeline().write("unit_test", "test_remove", items)
        print(df.head)
        self.assertEqual(len(items) - 2, len(df))

    def test_dup_inserts_by_id(self):
        items = json.loads(self.JSON_TEXT_ITEMS)
        items[2]["_id"] = 1
        items[2]["operation"] = "INSERT"
        df = FaissPipeline().write("unit_test", "test_dup_inserts_by_id", items)
        print(df.head)
        self.assertEqual(len(items) - 1, len(df))

    def test_dup_inserts_by_primary_key_value(self):
        items = json.loads(self.JSON_TEXT_ITEMS)
        items[2]["primary_key_value"] = "1"
        items[2]["operation"] = "INSERT"
        df = FaissPipeline().write(
            "unit_test", "test_dup_inserts_by_primary_key_value", items
        )
        print(df.head)
        self.assertEqual(len(items) - 1, len(df))
        self.assertEqual(df["column_value"][2], items[2]["column_value"])

    def test_duplicates_save_storage(self):
        items = json.loads(self.JSON_TEXT_ITEMS)
        df = FaissPipeline(storage_location=StorageLocation.LOCAL_DISK).write(
            "unit_test", "test_normal_inserts", items
        )
        print(df.head)
        df = FaissPipeline(storage_location=StorageLocation.LOCAL_DISK).write(
            "unit_test", "test_normal_inserts", items
        )
        print(df.head)
        self.assertEqual(len(items), len(df))

    def test_text_index_search(self):
        items = json.loads(self.JSON_TEXT_ITEMS)
        context = items[0]["column_value"]
        pipeline = FaissPipeline(storage_location=StorageLocation.MEMORY_CACHE)
        for item in items:
            (
                text_embedding,
                context_embedding,
                label_embedding,
                text_generated,
                labels_generated,
            ) = EmbedPipeline().encode(text=item["column_value"])
            item["embedding"] = json.dumps(text_embedding.tolist())
            item["context_embedding"] = json.dumps(context_embedding.tolist())
            item["label_embedding"] = json.dumps(label_embedding.tolist())
        df = pipeline.write("unit_test", "test_text_index_search", items)
        print(df.head)
        predictions = pipeline.search(
            database="unit_test",
            index_id="test_text_index_search",
            context=context,
            limit=10,
            primary_key_values=None,
        )
        self.assertEqual(len(items), len(df))
        self.assertEqual(predictions[0]["text"], context)

    def test_image_url_index_search(self):
        pipeline = FaissPipeline(storage_location=StorageLocation.MEMORY_CACHE)
        items = json.loads(self.JSON_IMAGE_ITEMS)
        image_url = random.choice(items)["column_value"]
        context = image_url
        for item in items:
            (
                text_embedding,
                context_embedding,
                label_embedding,
                text_generated,
                labels_generated,
            ) = EmbedPipeline().encode(text=item["column_value"])
            item["embedding"] = json.dumps(text_embedding.tolist())
            item["context_embedding"] = json.dumps(context_embedding.tolist())
            item["label_embedding"] = json.dumps(label_embedding.tolist())
        df = pipeline.write("unit_test", "test_image_index_search", items)
        print(df.head)
        predictions = pipeline.search(
            database="unit_test",
            index_id="test_image_index_search",
            context=context,
            limit=10,
            primary_key_values=None,
        )
        self.assertEqual(len(items), len(df))
        self.assertEqual(predictions[0]["text"], image_url)

    def test_image_text_index_search(self):
        pipeline = FaissPipeline(storage_location=StorageLocation.MEMORY_CACHE)
        items = json.loads(self.JSON_IMAGE_ITEMS)
        image_url = random.choice(items)["column_value"]
        texts, labels = ImageToTextPipeline().generate(image_url)
        context = ", ".join(texts)
        for item in items:
            (
                text_embedding,
                context_embedding,
                label_embedding,
                text_generated,
                labels_generated,
            ) = EmbedPipeline().encode(text=item["column_value"])
            item["embedding"] = json.dumps(text_embedding.tolist())
            item["context_embedding"] = json.dumps(context_embedding.tolist())
            item["label_embedding"] = json.dumps(label_embedding.tolist())
        df = pipeline.write("unit_test", "test_image_index_search", items)
        print(df.head)
        predictions = pipeline.search(
            database="unit_test",
            index_id="test_image_index_search",
            context=context,
            limit=10,
            primary_key_values=None,
        )
        self.assertEqual(len(items), len(df))
        self.assertEqual(predictions[0]["text"], image_url)

    def test_image_labels_index_search(self):
        pipeline = FaissPipeline(storage_location=StorageLocation.MEMORY_CACHE)
        items = json.loads(self.JSON_IMAGE_ITEMS)
        image_url = random.choice(items)["column_value"]
        texts, labels = ImageToTextPipeline().generate(image_url)
        context = ", ".join(labels)
        for item in items:
            (
                text_embedding,
                context_embedding,
                label_embedding,
                text_generated,
                labels_generated,
            ) = EmbedPipeline().encode(text=item["column_value"])
            item["embedding"] = json.dumps(text_embedding.tolist())
            item["context_embedding"] = json.dumps(context_embedding.tolist())
            item["label_embedding"] = json.dumps(label_embedding.tolist())
        df = pipeline.write("unit_test", "test_image_index_search", items)
        print(df.head)
        predictions = pipeline.search(
            database="unit_test",
            index_id="test_image_index_search",
            context=context,
            limit=10,
            primary_key_values=None,
        )
        self.assertEqual(len(items), len(df))
        self.assertEqual(predictions[0]["text"], image_url)

    def test_index_with_no_image_first_and_added_image_url_index_search(self):
        pipeline = FaissPipeline(storage_location=StorageLocation.MEMORY_CACHE)

        ##No Image
        items = json.loads(self.JSON_TEXT_ITEMS)
        image_url = random.choice(items)["column_value"]
        context = image_url
        size = len(items)
        for item in items:
            (
                text_embedding,
                context_embedding,
                label_embedding,
                text_generated,
                labels_generated,
            ) = EmbedPipeline().encode(text=item["column_value"])
            item["embedding"] = json.dumps(text_embedding.tolist())
            item["context_embedding"] = json.dumps(context_embedding.tolist())
            item["label_embedding"] = json.dumps(label_embedding.tolist())
        df = pipeline.write("unit_test", "test_image_index_search", items)
        print(df.head)

        ##HasImages
        items = json.loads(self.JSON_IMAGE_ITEMS)
        image_url = random.choice(items)["column_value"]
        context = image_url
        size = size + len(items)
        for item in items:
            (
                text_embedding,
                context_embedding,
                label_embedding,
                text_generated,
                labels_generated,
            ) = EmbedPipeline().encode(text=item["column_value"])
            item["embedding"] = json.dumps(text_embedding.tolist())
            item["context_embedding"] = json.dumps(context_embedding.tolist())
            item["label_embedding"] = json.dumps(label_embedding.tolist())
        df = pipeline.write("unit_test", "test_image_index_search", items)
        print(df.head)

        ##Search
        predictions = pipeline.search(
            database="unit_test",
            index_id="test_image_index_search",
            context=context,
            limit=10,
            primary_key_values=None,
        )
        self.assertEqual(size, len(df))
        self.assertEqual(predictions[0]["text"], image_url)


if __name__ == "__main__":
    unittest.main()
